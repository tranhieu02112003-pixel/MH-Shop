<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Đặt hàng</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="header">
  <h1>MH Shop</h1>
</header>

<main class="container">
  <h2>Đặt hàng</h2>

  <form id="orderForm">
    <label>Họ tên:</label>
    <input id="name" required>

    <label>Số điện thoại:</label>
    <input id="phone" required>

    <label>Địa chỉ (gửi nếu cần):</label>
    <input id="address">

    <label>Sản phẩm:</label>
    <select id="productSelect"></select>

    <label>Số lượng:</label>
    <input id="qty" type="number" value="1" min="1">

    <button type="submit" class="btn">Gửi đơn</button>
  </form>

  <p id="status" class="status"></p>
  
</main>

<!-- MQTT client -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="product-data.js"></script>
<script>
/*
  HƯỚNG DẪN NHANH:
  1) Tạo broker MQTT (EMQX Cloud / CloudMQTT) -> lấy WebSocket URL (wss://...) hoặc ws://...
  2) Điền HOST/PORT/USERNAME/PASSWORD ở biến mqttOptions dưới đây
  3) Mở app MQTT trên điện thoại (MQTTX/MQTT Dash) -> subscribe topic "shop/orders"
  4) Khách gửi đơn -> bạn sẽ nhận message real-time
*/

const productSelect = document.getElementById('productSelect');
productList.forEach(p => {
  const o = document.createElement('option');
  o.value = p.id; o.text = p.name + ' — ' + p.price;
  productSelect.appendChild(o);
});

// ===== CONFIGURE MQTT CONNECTION HERE =====
const MQTT_CONFIG = {
  brokerUrl: "wss://c92485726e2c42a2bd7c8157b4a15720.s1.eu.hivemq.cloud:8884/mqtt", // e.g. wss://broker.emqx.io:8084/mqtt
  options: {
    username: "TRANHIEU",
    password: "minhhieu0211",
    connectTimeout: 4000,
    reconnectPeriod: 1000
  },
  topic: "shop/orders"
};
// ==========================================

document.getElementById('brokerUrl').innerText = MQTT_CONFIG.brokerUrl;
document.getElementById('brokerUser').innerText = MQTT_CONFIG.options.username || '(none)';

let client = null;

function connectClient() {
  try {
    client = mqtt.connect(MQTT_CONFIG.brokerUrl, MQTT_CONFIG.options);
    client.on('connect', () => {
      console.log('MQTT connected');
      document.getElementById('status').innerText = 'Đã kết nối tới broker MQTT.';
    });
    client.on('error', (err) => {
      console.error('MQTT error', err);
      document.getElementById('status').innerText = 'Lỗi MQTT: ' + err.message;
    });
  } catch(e) {
    console.error('Connect failed', e);
    document.getElementById('status').innerText = 'Không thể kết nối MQTT (kiểm tra URL).';
  }
}

connectClient();

document.getElementById('orderForm').addEventListener('submit', function(e){
  e.preventDefault();
  if(!client || client.disconnected) {
    alert('Chưa kết nối MQTT. Kiểm tra cấu hình broker.');
    return;
  }
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();
  const productId = Number(document.getElementById('productSelect').value);
  const qty = Number(document.getElementById('qty').value) || 1;
  const product = productList.find(p => p.id === productId) || productList[0];

  if(!name || !phone) {
    alert('Vui lòng nhập họ tên và số điện thoại');
    return;
  }

  const order = {
    name, phone, address,
    productId, productName: product.name, price: product.price,
    qty, time: Date.now()
  };

  const payload = JSON.stringify(order);
  client.publish(MQTT_CONFIG.topic, payload, { qos: 0 }, (err) => {
    if(err) {
      console.error('Publish error', err);
      document.getElementById('status').innerText = 'Gửi đơn thất bại.';
    } else {
      document.getElementById('status').innerText = 'Đã gửi đơn thành công!';
      document.getElementById('orderForm').reset();
    }
  });
});
</script>
</body>
</html>
